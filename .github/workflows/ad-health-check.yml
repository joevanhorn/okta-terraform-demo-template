name: "AD: Health Check"

# Quick health check of AD Domain Controller services via SSM.
# Checks: NTDS, DNS, Netlogon, KDC, and bootstrap log.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name'
        required: true
        type: string
      region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  check-ad:
    name: Check AD Domain Controller
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-ADHealthCheck
          aws-region: ${{ inputs.region }}

      - name: Find Domain Controller Instance
        id: find-dc
        run: |
          echo "Searching for AD DC instance..."

          # Try multiple tag patterns for flexibility
          for PATTERN in "*-ad-dc*" "*ad-dc*" "*DomainController*"; do
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Name,Values=$PATTERN" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)

            if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
              echo "Found instance with pattern '$PATTERN': $INSTANCE_ID"
              break
            fi
          done

          # Also try tag-based discovery
          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Role,Values=DomainController,AD-DC" \
                "Name=tag:Environment,Values=${{ inputs.environment }}" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)
          fi

          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "::error::Could not find running AD DC instance"
            echo ""
            echo "Available instances:"
            aws ec2 describe-instances \
              --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value|[0]]' \
              --output table \
              --region ${{ inputs.region }}
            exit 1
          fi

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Check AD Services via SSM
        run: |
          INSTANCE_ID="${{ steps.find-dc.outputs.instance_id }}"
          echo "Checking AD services on $INSTANCE_ID..."

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters "commands=[
              \"hostname\",
              \"whoami\",
              \"Write-Host '=== AD Services ==='\",
              \"Get-Service -Name NTDS,DNS,Netlogon,KDC -ErrorAction SilentlyContinue | Format-Table Name,Status\",
              \"Write-Host '=== AD Features ==='\",
              \"Get-WindowsFeature AD-Domain-Services | Format-Table Name,InstallState\",
              \"Write-Host '=== Domain Info ==='\",
              \"try { Get-ADDomain | Select-Object Name,DomainMode,Forest | Format-List } catch { Write-Host 'AD not yet configured' }\",
              \"Write-Host '=== Bootstrap Log (last 30 lines) ==='\",
              \"if (Test-Path C:\\\\Terraform\\\\bootstrap.log) { Get-Content C:\\\\Terraform\\\\bootstrap.log -Tail 30 } else { Write-Host 'No bootstrap log found' }\"
            ]" \
            --query 'Command.CommandId' \
            --output text \
            --region ${{ inputs.region }})

          echo "Command ID: $COMMAND_ID"
          sleep 15

          for i in $(seq 1 30); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Pending")
            if [ "$STATUS" == "Success" ] || [ "$STATUS" == "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo ""
          echo "=========================================="
          echo "OUTPUT"
          echo "=========================================="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text \
            --region ${{ inputs.region }}

      - name: Summary
        if: always()
        run: |
          echo "## AD Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instance:** ${{ steps.find-dc.outputs.instance_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed service status." >> $GITHUB_STEP_SUMMARY
