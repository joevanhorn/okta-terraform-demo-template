name: "Diagnose: Network Connectivity"

# Diagnose network connectivity for an EC2 instance.
# Checks: NACLs, route tables, security groups, SSM server status, external access.

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 Instance ID'
        required: true
        type: string
      environment:
        description: 'Environment name (for AWS credentials)'
        required: true
        type: string
      region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  diagnose:
    name: Diagnose Connectivity
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-DiagnoseConn
          aws-region: ${{ inputs.region }}

      - name: Get Instance Details
        id: instance
        run: |
          DETAILS=$(aws ec2 describe-instances \
            --instance-ids "${{ inputs.instance_id }}" \
            --query 'Reservations[0].Instances[0].[PublicIpAddress,SubnetId,VpcId]' \
            --output text \
            --region ${{ inputs.region }})
          PUBLIC_IP=$(echo "$DETAILS" | cut -f1)
          SUBNET_ID=$(echo "$DETAILS" | cut -f2)
          VPC_ID=$(echo "$DETAILS" | cut -f3)
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "SUBNET_ID=$SUBNET_ID" >> $GITHUB_OUTPUT
          echo "VPC_ID=$VPC_ID" >> $GITHUB_OUTPUT
          echo "Instance: $PUBLIC_IP in $SUBNET_ID ($VPC_ID)"

      - name: Check Network ACLs
        run: |
          echo "=========================================="
          echo "NETWORK ACL RULES"
          echo "=========================================="

          NACL_ID=$(aws ec2 describe-network-acls \
            --filters "Name=association.subnet-id,Values=${{ steps.instance.outputs.SUBNET_ID }}" \
            --query 'NetworkAcls[0].NetworkAclId' \
            --output text \
            --region ${{ inputs.region }})

          echo "NACL: $NACL_ID"
          echo ""
          echo "--- INBOUND ---"
          aws ec2 describe-network-acls \
            --network-acl-ids "$NACL_ID" \
            --query 'NetworkAcls[0].Entries[?Egress==`false`]' \
            --output table \
            --region ${{ inputs.region }}
          echo ""
          echo "--- OUTBOUND ---"
          aws ec2 describe-network-acls \
            --network-acl-ids "$NACL_ID" \
            --query 'NetworkAcls[0].Entries[?Egress==`true`]' \
            --output table \
            --region ${{ inputs.region }}

      - name: Check Route Table
        run: |
          echo "=========================================="
          echo "ROUTE TABLE"
          echo "=========================================="
          aws ec2 describe-route-tables \
            --filters "Name=association.subnet-id,Values=${{ steps.instance.outputs.SUBNET_ID }}" \
            --query 'RouteTables[0].Routes' \
            --output table \
            --region ${{ inputs.region }}

      - name: Check Server Status via SSM
        run: |
          echo "=========================================="
          echo "SERVER STATUS (via SSM)"
          echo "=========================================="

          # Detect OS type
          PLATFORM=$(aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ inputs.instance_id }}" \
            --query 'InstanceInformationList[0].PlatformType' \
            --output text \
            --region ${{ inputs.region }} 2>/dev/null || echo "Unknown")

          if [ "$PLATFORM" == "Linux" ]; then
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "${{ inputs.instance_id }}" \
              --document-name "AWS-RunShellScript" \
              --timeout-seconds 60 \
              --parameters "commands=[
                'echo \"=== Listening Ports ===\"',
                'ss -tlnp 2>/dev/null || netstat -tlnp 2>/dev/null',
                'echo \"\"',
                'echo \"=== Services ===\"',
                'systemctl list-units --type=service --state=running --no-pager | head -20',
                'echo \"\"',
                'echo \"=== Disk Usage ===\"',
                'df -h',
                'echo \"\"',
                'echo \"=== Network Interfaces ===\"',
                'ip addr show 2>/dev/null || ifconfig'
              ]" \
              --query 'Command.CommandId' \
              --output text \
              --region ${{ inputs.region }})
          else
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "${{ inputs.instance_id }}" \
              --document-name "AWS-RunPowerShellScript" \
              --timeout-seconds 60 \
              --parameters "commands=[
                \"Get-NetTCPConnection -State Listen | Select-Object LocalPort,OwningProcess | Sort-Object LocalPort | Format-Table\",
                \"Get-Service | Where-Object Status -eq Running | Select-Object Name,DisplayName | Format-Table\",
                \"Get-PSDrive -PSProvider FileSystem | Format-Table Name,Used,Free\"
              ]" \
              --query 'Command.CommandId' \
              --output text \
              --region ${{ inputs.region }})
          fi

          echo "Platform: $PLATFORM, Command ID: $COMMAND_ID"
          sleep 15

          for i in $(seq 1 24); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ inputs.instance_id }}" \
              --query 'Status' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Pending")
            if [ "$STATUS" == "Success" ] || [ "$STATUS" == "Failed" ]; then
              break
            fi
            sleep 5
          done

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ inputs.instance_id }}" \
            --query 'StandardOutputContent' \
            --output text \
            --region ${{ inputs.region }}

      - name: Test External Connectivity
        if: steps.instance.outputs.PUBLIC_IP != 'None'
        run: |
          echo "=========================================="
          echo "EXTERNAL CONNECTIVITY TEST"
          echo "=========================================="
          PUBLIC_IP="${{ steps.instance.outputs.PUBLIC_IP }}"
          echo "Testing from GitHub Actions to $PUBLIC_IP"
          echo "(Note: GitHub IPs may not be whitelisted)"
          echo ""

          for PORT in 443 80 3389 22; do
            echo -n "Port $PORT: "
            timeout 5 bash -c "echo >/dev/tcp/$PUBLIC_IP/$PORT" 2>/dev/null && echo "OPEN" || echo "closed/filtered"
          done

      - name: Summary
        run: |
          echo "## Connectivity Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Instance** | \`${{ inputs.instance_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Public IP** | ${{ steps.instance.outputs.PUBLIC_IP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **VPC** | ${{ steps.instance.outputs.VPC_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Subnet** | ${{ steps.instance.outputs.SUBNET_ID }} |" >> $GITHUB_STEP_SUMMARY
