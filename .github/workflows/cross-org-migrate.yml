name: Cross-Org Migration

on:
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Resource type to migrate'
        required: true
        type: choice
        options:
          - groups
          - memberships
          - grants
      source_environment:
        description: 'Source environment (to export from)'
        required: true
        type: string
      target_environment:
        description: 'Target environment (to import to)'
        required: true
        type: string
      name_pattern:
        description: 'Name pattern filter (regex, for groups only)'
        required: false
        type: string
        default: ''
      exclude_system:
        description: 'Exclude system groups (Everyone, Administrators)'
        required: false
        type: boolean
        default: true
      exclude_apps:
        description: 'Apps to exclude (comma-separated, for grants only)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (preview only)'
        required: true
        type: boolean
        default: true
      commit_changes:
        description: 'Commit generated files (for groups only)'
        required: false
        type: boolean
        default: true

# ============================================================================
# GROUPS MIGRATION
# ============================================================================
jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Check environments are different
        run: |
          if [ "${{ inputs.source_environment }}" == "${{ inputs.target_environment }}" ]; then
            echo "::error::Source and target environments must be different"
            exit 1
          fi
          echo "Will migrate ${{ inputs.resource_type }} from ${{ inputs.source_environment }} to ${{ inputs.target_environment }}"

  # --- GROUPS: Export from source ---
  export-groups:
    name: Export Groups from Source
    if: inputs.resource_type == 'groups'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.source_environment }}
    outputs:
      resource_count: ${{ steps.export.outputs.resource_count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      - name: Export Groups from Source Org
        id: export
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Exporting groups from ${{ inputs.source_environment }}..."

          OUTPUT_FILE="environments/${{ inputs.target_environment }}/terraform/groups_imported.tf"

          CMD="python3 scripts/export_groups_to_terraform.py --output $OUTPUT_FILE"

          if [ "${{ inputs.exclude_system }}" == "true" ]; then
            CMD="$CMD --exclude-system"
          fi

          if [ -n "${{ inputs.name_pattern }}" ]; then
            CMD="$CMD --name-pattern '${{ inputs.name_pattern }}'"
          fi

          echo "Running: $CMD"
          eval $CMD

          # Count resources
          RESOURCE_COUNT=$(grep -c 'resource "okta_group"' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          echo "Generated $RESOURCE_COUNT group resources"
          echo "resource_count=$RESOURCE_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Generated Terraform
        uses: actions/upload-artifact@v4
        with:
          name: groups-terraform
          path: environments/${{ inputs.target_environment }}/terraform/groups_imported.tf
          retention-days: 1

  # --- GROUPS: Import to target ---
  import-groups:
    name: Import Groups to Target
    if: inputs.resource_type == 'groups'
    needs: export-groups
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Generated Terraform
        uses: actions/download-artifact@v4
        with:
          name: groups-terraform
          path: environments/${{ inputs.target_environment }}/terraform/

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
          terraform_wrapper: false

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CrossOrgMigrate
          aws-region: us-east-1

      - name: Terraform Init
        working-directory: environments/${{ inputs.target_environment }}/terraform
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_base_url: ${{ secrets.OKTA_BASE_URL }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
        run: terraform init

      - name: Terraform Plan
        working-directory: environments/${{ inputs.target_environment }}/terraform
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_base_url: ${{ secrets.OKTA_BASE_URL }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          terraform plan -out=tfplan 2>&1 | tee plan_output.txt
          echo ""
          echo "=========================================="
          echo "PLAN SUMMARY"
          echo "=========================================="
          grep -E "(Plan:|No changes|to add|to change|to destroy)" plan_output.txt || echo "See full output above"

      - name: Terraform Apply
        if: inputs.dry_run == false
        working-directory: environments/${{ inputs.target_environment }}/terraform
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          TF_VAR_okta_org_name: ${{ secrets.OKTA_ORG_NAME }}
          TF_VAR_okta_base_url: ${{ secrets.OKTA_BASE_URL }}
          TF_VAR_okta_api_token: ${{ secrets.OKTA_API_TOKEN }}
        run: terraform apply -auto-approve tfplan

      - name: Commit Changes
        if: inputs.commit_changes == true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add environments/${{ inputs.target_environment }}/terraform/groups_imported.tf
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Import groups from ${{ inputs.source_environment }}

          Groups imported for policy-based entitlement assignments.
          Resource count: ${{ needs.export-groups.outputs.resource_count }}

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
            git push
          fi

      - name: Summary
        run: |
          echo "## Cross-Org Migration: Groups" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${{ inputs.source_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | ${{ inputs.target_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Groups | ${{ needs.export-groups.outputs.resource_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | ${{ inputs.dry_run == true && 'Dry Run' || 'Applied' }} |" >> $GITHUB_STEP_SUMMARY

# ============================================================================
# MEMBERSHIPS MIGRATION
# ============================================================================
  export-memberships:
    name: Export Memberships from Source
    if: inputs.resource_type == 'memberships'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.source_environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      - name: Export Group Memberships
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Exporting group memberships from ${{ inputs.source_environment }}..."
          python3 scripts/copy_group_memberships.py export \
            --output memberships.json \
            --exclude-system

      - name: Upload Memberships File
        uses: actions/upload-artifact@v4
        with:
          name: group-memberships
          path: memberships.json
          retention-days: 1

  import-memberships:
    name: Import Memberships to Target
    if: inputs.resource_type == 'memberships'
    needs: export-memberships
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      - name: Download Memberships File
        uses: actions/download-artifact@v4
        with:
          name: group-memberships
          path: .

      - name: Show Memberships File
        run: |
          echo "Downloaded memberships file:"
          cat memberships.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Groups: {d[\"group_count\"]}, Members: {d[\"total_members\"]}')"

      - name: Import Group Memberships
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "Importing group memberships to ${{ inputs.target_environment }} (DRY RUN)..."
            python3 scripts/copy_group_memberships.py import --input memberships.json --dry-run
          else
            echo "Importing group memberships to ${{ inputs.target_environment }}..."
            python3 scripts/copy_group_memberships.py import --input memberships.json
          fi

      - name: Summary
        run: |
          echo "## Cross-Org Migration: Memberships" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${{ inputs.source_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | ${{ inputs.target_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | ${{ inputs.dry_run == true && 'Dry Run' || 'Applied' }} |" >> $GITHUB_STEP_SUMMARY

# ============================================================================
# GRANTS MIGRATION
# ============================================================================
  export-grants:
    name: Export Grants from Source
    if: inputs.resource_type == 'grants'
    needs: validate-inputs
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.source_environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Export grants
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Exporting grants from ${{ inputs.source_environment }}..."
          python3 scripts/copy_grants_between_orgs.py export \
            --output grants_export.json \
            --verbose

          # Show summary
          echo "## Export Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          GRANT_COUNT=$(python3 -c "import json; d=json.load(open('grants_export.json')); print(len(d['grants']))")
          BUNDLE_COUNT=$(python3 -c "import json; d=json.load(open('grants_export.json')); print(len(d['bundles']))")
          echo "**Grants exported:** $GRANT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Bundles:** $BUNDLE_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Upload export artifact
        uses: actions/upload-artifact@v4
        with:
          name: grants-export
          path: grants_export.json
          retention-days: 1

  import-grants:
    name: Import Grants to Target
    if: inputs.resource_type == 'grants'
    needs: export-grants
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Download export artifact
        uses: actions/download-artifact@v4
        with:
          name: grants-export

      - name: Import grants
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Importing grants to ${{ inputs.target_environment }}..."

          CMD="python3 scripts/copy_grants_between_orgs.py import --input grants_export.json --verbose"

          # Handle comma-separated exclusions
          if [ -n "${{ inputs.exclude_apps }}" ]; then
            IFS=',' read -ra APPS <<< "${{ inputs.exclude_apps }}"
            for app in "${APPS[@]}"; do
              app=$(echo "$app" | xargs)
              CMD="$CMD --exclude-apps '$app'"
            done
          fi

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          eval $CMD | tee import_output.txt

          # Summary
          echo "## Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.exclude_apps }}" ]; then
            echo "**Excluded Apps:** ${{ inputs.exclude_apps }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 import_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload import results
        uses: actions/upload-artifact@v4
        with:
          name: import-results
          path: import_output.txt
          retention-days: 7
