name: Auto-Enable Entitlement Management

# This workflow automatically enables entitlement management on apps when
# Terraform files containing okta_entitlement or okta_entitlement_bundle
# resources are merged to main.
#
# SETUP REQUIRED:
# 1. Create a repository variable named AUTO_ENABLE_ENTITLEMENTS
# 2. Set it to "true" to enable this feature (default: disabled)
#
# To enable: Settings > Secrets and variables > Actions > Variables > New
# Name: AUTO_ENABLE_ENTITLEMENTS
# Value: true

on:
  push:
    branches:
      - main
    paths:
      - 'environments/*/terraform/**entitlement*.tf'
      - 'environments/*/terraform/**/entitlement*.tf'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        type: choice
        options:
          - myorg
          - production
          - staging
          - development
      dry_run:
        description: 'Dry run (preview only)'
        required: true
        type: boolean
        default: true
      force:
        description: 'Force run even if AUTO_ENABLE_ENTITLEMENTS is not set'
        required: false
        type: boolean
        default: false

jobs:
  check-feature-flag:
    name: Check Feature Flag
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}

    steps:
      - name: Check if feature is enabled
        id: check
        run: |
          # Check if AUTO_ENABLE_ENTITLEMENTS is set to "true"
          if [ "${{ vars.AUTO_ENABLE_ENTITLEMENTS }}" == "true" ]; then
            echo "Feature is enabled via repository variable"
            echo "enabled=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.force }}" == "true" ]; then
            echo "Feature force-enabled via workflow input"
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "Feature is disabled"
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo ""
            echo "To enable this feature:"
            echo "1. Go to Settings > Secrets and variables > Actions > Variables"
            echo "2. Create variable: AUTO_ENABLE_ENTITLEMENTS = true"
          fi

  detect-environment:
    name: Detect Environment
    needs: check-feature-flag
    if: needs.check-feature-flag.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect environment from changes
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Get changed files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

            # Find entitlement-related TF files
            ENTITLEMENT_FILES=$(echo "$CHANGED_FILES" | grep -E "environments/.*/terraform/.*entitlement.*\.tf$" || true)

            if [ -z "$ENTITLEMENT_FILES" ]; then
              echo "No entitlement TF files changed"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "environment=" >> $GITHUB_OUTPUT
            else
              echo "Found entitlement TF files:"
              echo "$ENTITLEMENT_FILES"

              # Extract environment from first matched file
              ENV_NAME=$(echo "$ENTITLEMENT_FILES" | head -1 | sed 's|environments/\([^/]*\)/terraform/.*|\1|')
              echo "Detected environment: $ENV_NAME"
              echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi

  detect-apps:
    name: Detect Apps with Entitlements
    needs: [check-feature-flag, detect-environment]
    if: needs.check-feature-flag.outputs.enabled == 'true' && needs.detect-environment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      app_labels: ${{ steps.detect.outputs.app_labels }}
      has_apps: ${{ steps.detect.outputs.has_apps }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect apps with entitlements
        id: detect
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          # Run detection script
          python scripts/detect_entitlement_apps.py \
            --environment "$ENV" \
            --resolve-labels \
            --json > detection_output.json

          cat detection_output.json

          # Extract app labels for API lookup
          APP_LABELS=$(jq -r '.resolved_labels | values | @json' detection_output.json)
          REF_COUNT=$(jq '.terraform_references | length' detection_output.json)
          ID_COUNT=$(jq '.app_ids | length' detection_output.json)

          echo "Found $REF_COUNT Terraform references, $ID_COUNT literal IDs"

          if [ "$REF_COUNT" -gt 0 ] || [ "$ID_COUNT" -gt 0 ]; then
            echo "has_apps=true" >> $GITHUB_OUTPUT
            echo "app_labels=$APP_LABELS" >> $GITHUB_OUTPUT
          else
            echo "has_apps=false" >> $GITHUB_OUTPUT
            echo "app_labels=[]" >> $GITHUB_OUTPUT
          fi

      - name: Upload detection results
        uses: actions/upload-artifact@v4
        with:
          name: entitlement-detection-${{ needs.detect-environment.outputs.environment }}
          path: detection_output.json
          retention-days: 7

  enable-entitlements:
    name: Enable Entitlement Management
    needs: [check-feature-flag, detect-environment, detect-apps]
    if: needs.check-feature-flag.outputs.enabled == 'true' && needs.detect-apps.outputs.has_apps == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.detect-environment.outputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Download detection results
        uses: actions/download-artifact@v4
        with:
          name: entitlement-detection-${{ needs.detect-environment.outputs.environment }}

      - name: Enable entitlement management on detected apps
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          echo "=== Auto-Enable Entitlement Management ==="
          echo "Environment: $ENV"
          echo "Dry Run: $DRY_RUN"
          echo ""

          # Get app labels from detection
          APP_LABELS=$(jq -r '.resolved_labels | to_entries[] | .value' detection_output.json 2>/dev/null || echo "")

          if [ -z "$APP_LABELS" ]; then
            echo "No app labels resolved - checking for literal app IDs"
            APP_IDS=$(jq -r '.app_ids[]' detection_output.json 2>/dev/null || echo "")

            if [ -n "$APP_IDS" ]; then
              for APP_ID in $APP_IDS; do
                echo "Processing app ID: $APP_ID"

                if [ "$DRY_RUN" == "true" ]; then
                  echo "  [DRY RUN] Would enable entitlement management"
                  python scripts/manage_entitlement_settings.py \
                    --action enable \
                    --app-id "$APP_ID" \
                    --dry-run || true
                else
                  python scripts/manage_entitlement_settings.py \
                    --action enable \
                    --app-id "$APP_ID" || true
                fi
              done
            else
              echo "No apps found to enable"
            fi
          else
            for LABEL in $APP_LABELS; do
              echo "Processing app: $LABEL"

              if [ "$DRY_RUN" == "true" ]; then
                echo "  [DRY RUN] Would enable entitlement management"
                python scripts/manage_entitlement_settings.py \
                  --action enable \
                  --app-label "$LABEL" \
                  --dry-run || true
              else
                python scripts/manage_entitlement_settings.py \
                  --action enable \
                  --app-label "$LABEL" || true
              fi
            done
          fi

      - name: Post summary
        if: always()
        run: |
          echo "## Auto-Enable Entitlement Management Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Mode:** DRY RUN (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** APPLY" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat detection_output.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow was triggered because entitlement Terraform files were detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature controlled by:** \`AUTO_ENABLE_ENTITLEMENTS\` repository variable" >> $GITHUB_STEP_SUMMARY

  skip-notification:
    name: Feature Disabled
    needs: check-feature-flag
    if: needs.check-feature-flag.outputs.enabled != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Post skip notice
        run: |
          echo "## Auto-Enable Entitlements Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The auto-enable entitlements feature is **disabled**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Enable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Settings** > **Secrets and variables** > **Actions** > **Variables**" >> $GITHUB_STEP_SUMMARY
          echo "2. Click **New repository variable**" >> $GITHUB_STEP_SUMMARY
          echo "3. Name: \`AUTO_ENABLE_ENTITLEMENTS\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Value: \`true\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Once enabled, this workflow will automatically enable entitlement management" >> $GITHUB_STEP_SUMMARY
          echo "on apps when Terraform files containing \`okta_entitlement\` or \`okta_entitlement_bundle\`" >> $GITHUB_STEP_SUMMARY
          echo "resources are merged to main." >> $GITHUB_STEP_SUMMARY
