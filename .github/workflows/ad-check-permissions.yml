name: "AD: Check Service Account Permissions"

# Verifies Okta service account permissions on AD OUs.
# Checks group memberships, Domain Admins, and OU ACLs.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name'
        required: true
        type: string
      service_account:
        description: 'Service account name (e.g., okta-svc)'
        required: true
        type: string
      region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  check-permissions:
    name: Check AD Permissions
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-ADPermissions
          aws-region: ${{ inputs.region }}

      - name: Find Domain Controller Instance
        id: find-dc
        run: |
          for PATTERN in "*-ad-dc*" "*ad-dc*" "*DomainController*"; do
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Name,Values=$PATTERN" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)
            if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
              break
            fi
          done

          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Role,Values=DomainController,AD-DC" \
                "Name=tag:Environment,Values=${{ inputs.environment }}" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)
          fi

          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "::error::AD DC instance not found"
            exit 1
          fi
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Check Service Account and Permissions
        run: |
          SERVICE_ACCOUNT="${{ inputs.service_account }}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.find-dc.outputs.instance_id }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters "commands=[
              \"Import-Module ActiveDirectory\",
              \"Write-Host '=== Service Account Info ==='\",
              \"try { Get-ADUser -Identity '${SERVICE_ACCOUNT}' -Properties * | Select-Object Name, SamAccountName, Enabled, MemberOf | Format-List } catch { Write-Host 'Service account not found: ${SERVICE_ACCOUNT}' }\",
              \"Write-Host ''\",
              \"Write-Host '=== Group Memberships ==='\",
              \"try { (Get-ADUser -Identity '${SERVICE_ACCOUNT}' -Properties MemberOf).MemberOf | ForEach-Object { (Get-ADGroup \\\$_).Name } } catch { Write-Host 'Could not get group memberships' }\",
              \"Write-Host ''\",
              \"Write-Host '=== Domain Admins ==='\",
              \"Get-ADGroupMember -Identity 'Domain Admins' | Select-Object Name, SamAccountName | Format-Table\",
              \"Write-Host ''\",
              \"Write-Host '=== Top-Level OUs ==='\",
              \"Get-ADOrganizationalUnit -Filter * -SearchScope OneLevel | Select-Object Name, DistinguishedName | Format-Table\",
              \"Write-Host ''\",
              \"Write-Host '=== Service Accounts ==='\",
              \"Get-ADUser -Filter {Name -like '*svc*' -or Name -like '*okta*' -or Name -like '*service*'} | Select-Object Name, SamAccountName, Enabled | Format-Table\"
            ]" \
            --query 'Command.CommandId' \
            --output text \
            --region ${{ inputs.region }})

          echo "Command ID: $COMMAND_ID"
          sleep 15

          for i in $(seq 1 30); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ steps.find-dc.outputs.instance_id }}" \
              --query 'Status' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Pending")
            if [ "$STATUS" == "Success" ] || [ "$STATUS" == "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo ""
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.find-dc.outputs.instance_id }}" \
            --query 'StandardOutputContent' \
            --output text \
            --region ${{ inputs.region }}
