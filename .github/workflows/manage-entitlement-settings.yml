name: Manage Entitlement Settings

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'myorg'
        type: choice
        options:
          - myorg
          - production
          - staging
          - development
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - list
          - status
          - enable
          - disable
        default: list
      app_id:
        description: 'App ID (required for status/enable/disable)'
        required: false
        type: string
      app_label:
        description: 'App label pattern (supports wildcards like Sales*)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (preview changes only)'
        required: true
        type: boolean
        default: true

jobs:
  manage-settings:
    name: Manage Entitlement Settings
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.environment }}

    permissions:
      contents: read
      actions: read

    steps:
      - name: Workflow Overview
        run: |
          echo "=================================================="
          echo "  MANAGE ENTITLEMENT SETTINGS"
          echo "=================================================="
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "Action: ${{ inputs.action }}"
          echo "App ID: ${{ inputs.app_id || 'Not specified' }}"
          echo "App Label: ${{ inputs.app_label || 'Not specified' }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo "=================================================="
          echo ""
          echo "Note: The Entitlement Settings API is in Beta (December 2025)."
          echo "This API allows enabling/disabling entitlement management on apps."
          echo "=================================================="

      - name: Validate inputs
        if: ${{ inputs.action != 'list' && inputs.app_id == '' && inputs.app_label == '' }}
        run: |
          echo "Error: For ${{ inputs.action }} action, either app_id or app_label is required"
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run entitlement settings management
        id: manage
        env:
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
        run: |
          ARGS="--action ${{ inputs.action }}"

          if [ -n "${{ inputs.app_id }}" ]; then
            ARGS="$ARGS --app-id ${{ inputs.app_id }}"
          fi

          if [ -n "${{ inputs.app_label }}" ]; then
            ARGS="$ARGS --app-label '${{ inputs.app_label }}'"
          fi

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          echo "Running: python scripts/manage_entitlement_settings.py $ARGS"
          echo ""

          # Run the script and capture output
          eval "python scripts/manage_entitlement_settings.py $ARGS" 2>&1 | tee output.log

          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: entitlement-settings-${{ inputs.environment }}-${{ inputs.action }}-${{ github.run_number }}
          path: |
            output.log
          retention-days: 30

      - name: Post summary
        if: always()
        run: |
          echo "## Entitlement Settings Management Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ inputs.app_id }}" ]; then
            echo "**App ID:** ${{ inputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ inputs.app_label }}" ]; then
            echo "**App Label Pattern:** ${{ inputs.app_label }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.action }}" != "list" ] && [ "${{ inputs.action }}" != "status" ]; then
            if [ "${{ inputs.dry_run }}" == "true" ]; then
              echo "**Mode:** DRY RUN (no changes made)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Mode:** APPLY (changes applied)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" == "true" ] && [ "${{ inputs.action }}" != "list" ] && [ "${{ inputs.action }}" != "status" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Next Step:** Re-run this workflow with dry_run=false to apply changes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: The Entitlement Settings API is in Beta (released December 2025)*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Reference:** [Entitlement Settings API](https://developer.okta.com/docs/api/iga/openapi/governance.api/tag/Entitlement-Settings/)" >> $GITHUB_STEP_SUMMARY
