name: Copy Grants Between Orgs

on:
  workflow_dispatch:
    inputs:
      source_environment:
        description: 'Source environment (to export from)'
        required: true
        type: string
      target_environment:
        description: 'Target environment (to import to)'
        required: true
        type: string
      exclude_apps:
        description: 'App names to exclude (comma-separated, optional)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (preview only)'
        required: true
        type: boolean
        default: true

jobs:
  export-grants:
    name: Export Grants from Source
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.source_environment }}
    outputs:
      export_file: ${{ steps.export.outputs.file }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Export grants
        id: export
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Exporting grants from ${{ inputs.source_environment }}..."
          python3 scripts/copy_grants_between_orgs.py export \
            --output grants_export.json \
            --verbose

          echo "file=grants_export.json" >> $GITHUB_OUTPUT

          # Show summary
          echo "## Export Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ inputs.source_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count grants
          GRANT_COUNT=$(python3 -c "import json; d=json.load(open('grants_export.json')); print(len(d['grants']))")
          BUNDLE_COUNT=$(python3 -c "import json; d=json.load(open('grants_export.json')); print(len(d['bundles']))")
          echo "**Grants exported:** $GRANT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Bundles:** $BUNDLE_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Upload export artifact
        uses: actions/upload-artifact@v4
        with:
          name: grants-export
          path: grants_export.json
          retention-days: 1

  import-grants:
    name: Import Grants to Target
    needs: export-grants
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Download export artifact
        uses: actions/download-artifact@v4
        with:
          name: grants-export

      - name: Import grants
        env:
          OKTA_ORG_NAME: ${{ secrets.OKTA_ORG_NAME }}
          OKTA_BASE_URL: ${{ secrets.OKTA_BASE_URL }}
          OKTA_API_TOKEN: ${{ secrets.OKTA_API_TOKEN }}
        run: |
          echo "Importing grants to ${{ inputs.target_environment }}..."

          # Build command
          CMD="python3 scripts/copy_grants_between_orgs.py import --input grants_export.json --verbose"

          # Handle comma-separated exclusions
          if [ -n "${{ inputs.exclude_apps }}" ]; then
            IFS=',' read -ra APPS <<< "${{ inputs.exclude_apps }}"
            for app in "${APPS[@]}"; do
              app=$(echo "$app" | xargs)  # trim whitespace
              CMD="$CMD --exclude-apps '$app'"
            done
          fi

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          eval $CMD | tee import_output.txt

          # Summary
          echo "## Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.exclude_apps }}" ]; then
            echo "### Exclusions" >> $GITHUB_STEP_SUMMARY
            echo "- Apps: ${{ inputs.exclude_apps }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 import_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload import results
        uses: actions/upload-artifact@v4
        with:
          name: import-results
          path: import_output.txt
          retention-days: 7
