name: "SCIM: Check Server Status"

# Diagnose SCIM server health: process status, ports, logs, endpoints.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name'
        required: true
        type: string
      region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  check-scim:
    name: Check SCIM Server
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SCIMCheck
          aws-region: ${{ inputs.region }}

      - name: Find SCIM Server Instance
        id: find-instance
        run: |
          # Try tag-based discovery with multiple patterns
          for PATTERN in "*scim*" "*SCIM*"; do
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Name,Values=$PATTERN" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)
            if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
              break
            fi
          done

          # Also try Role tag
          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters \
                "Name=tag:Role,Values=SCIM-Server,scim-server" \
                "Name=tag:Environment,Values=${{ inputs.environment }}" \
                "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null)
          fi

          # Try Terraform state
          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            if [ -d "environments/${{ inputs.environment }}/infrastructure/scim-server" ]; then
              cd "environments/${{ inputs.environment }}/infrastructure/scim-server"
              terraform init -backend=true > /dev/null 2>&1 || true
              INSTANCE_ID=$(terraform output -raw ec2_instance_id 2>/dev/null || terraform output -raw instance_id 2>/dev/null || echo "")
            fi
          fi

          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "::error::SCIM server instance not found"
            exit 1
          fi

          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text \
            --region ${{ inputs.region }} 2>/dev/null || echo "None")

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "Found SCIM server: $INSTANCE_ID (IP: $PUBLIC_IP)"

      - name: Check SCIM Server Status via SSM
        run: |
          INSTANCE_ID="${{ steps.find-instance.outputs.instance_id }}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 60 \
            --parameters "commands=[
              'echo \"=== SCIM Process ===\"',
              'ps aux | grep -i scim | grep -v grep || echo \"No SCIM process found\"',
              'echo \"\"',
              'echo \"=== Listening Ports ===\"',
              'ss -tlnp | grep -E \":80|:443|:8080|:8443\" || echo \"No matching ports\"',
              'echo \"\"',
              'echo \"=== Service Status ===\"',
              'systemctl status scim-server --no-pager 2>/dev/null || systemctl status nginx --no-pager 2>/dev/null || echo \"No SCIM service found\"',
              'echo \"\"',
              'echo \"=== Health Check ===\"',
              'curl -s http://localhost:8080/health 2>/dev/null || curl -s http://localhost/health 2>/dev/null || echo \"Health endpoint not responding\"',
              'echo \"\"',
              'echo \"=== Recent Logs (last 20 lines) ===\"',
              'journalctl -u scim-server -n 20 --no-pager 2>/dev/null || tail -20 /var/log/scim/*.log 2>/dev/null || echo \"No logs found\"',
              'echo \"\"',
              'echo \"=== Disk Usage ===\"',
              'df -h',
              'echo \"\"',
              'echo \"=== OPA Agent (if installed) ===\"',
              'systemctl status sftd --no-pager 2>/dev/null || echo \"sftd not installed\"'
            ]" \
            --query 'Command.CommandId' \
            --output text \
            --region ${{ inputs.region }})

          echo "Command ID: $COMMAND_ID"

          for i in $(seq 1 24); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Pending")
            if [ "$STATUS" == "Success" ] || [ "$STATUS" == "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo ""
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text \
            --region ${{ inputs.region }}

      - name: Test External Health Endpoint
        if: steps.find-instance.outputs.public_ip != 'None'
        run: |
          PUBLIC_IP="${{ steps.find-instance.outputs.public_ip }}"
          echo "Testing external health endpoints..."
          echo ""
          echo "HTTP: http://$PUBLIC_IP:8080/health"
          curl -s --connect-timeout 5 "http://$PUBLIC_IP:8080/health" 2>/dev/null || echo "Not reachable"
          echo ""
          echo "HTTPS: https://$PUBLIC_IP/health"
          curl -sk --connect-timeout 5 "https://$PUBLIC_IP/health" 2>/dev/null || echo "Not reachable"

      - name: Summary
        run: |
          echo "## SCIM Server Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Instance** | \`${{ steps.find-instance.outputs.instance_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Public IP** | ${{ steps.find-instance.outputs.public_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed status." >> $GITHUB_STEP_SUMMARY
