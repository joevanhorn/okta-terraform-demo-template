# ==============================================================================
# OKTA AD AGENT INSTALLATION WORKFLOW
# ==============================================================================
# Installs or updates the Okta AD Agent on Windows domain controllers
# via AWS Systems Manager (SSM).
#
# Prerequisites:
# - AD Domain Controller must be deployed and running
# - Instance must have SSM agent installed and connected
# - Okta AD Agent registration token from Okta Admin Console
#
# Usage:
#   gh workflow run ad-install-okta-agent.yml \
#     -f environment=myorg \
#     -f region=us-east-1
# ==============================================================================

name: AD - Install Okta Agent

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'myorg'
      region:
        description: 'AWS region where AD is deployed'
        required: true
        type: string
        default: 'us-east-1'
      instance_id:
        description: 'EC2 Instance ID (leave empty to auto-detect from SSM Parameter)'
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.region }}

jobs:
  install-agent:
    name: Install Okta AD Agent
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-OktaAgent
          aws-region: ${{ inputs.region }}

      - name: Get Instance ID
        id: get-instance
        run: |
          if [ -n "${{ inputs.instance_id }}" ]; then
            INSTANCE_ID="${{ inputs.instance_id }}"
          else
            # Get from SSM Parameter Store
            INSTANCE_ID=$(aws ssm get-parameter \
              --name "/${{ inputs.environment }}/ad/instance-id" \
              --query "Parameter.Value" \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "")

            if [ -z "$INSTANCE_ID" ]; then
              echo "Error: Could not find instance ID. Please specify it manually."
              exit 1
            fi
          fi

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Found Instance ID: $INSTANCE_ID"

      - name: Verify Instance is Running
        run: |
          INSTANCE_STATE=$(aws ec2 describe-instances \
            --instance-ids ${{ steps.get-instance.outputs.instance_id }} \
            --query "Reservations[0].Instances[0].State.Name" \
            --output text \
            --region ${{ inputs.region }})

          if [ "$INSTANCE_STATE" != "running" ]; then
            echo "Error: Instance is not running (state: $INSTANCE_STATE)"
            exit 1
          fi

          echo "Instance is running"

      - name: Wait for SSM Agent
        run: |
          echo "Waiting for SSM agent to be online..."
          for i in {1..30}; do
            SSM_STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${{ steps.get-instance.outputs.instance_id }}" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Offline")

            if [ "$SSM_STATUS" = "Online" ]; then
              echo "SSM agent is online"
              break
            fi

            if [ $i -eq 30 ]; then
              echo "Error: SSM agent not online after 5 minutes"
              exit 1
            fi

            echo "Waiting for SSM agent... ($i/30)"
            sleep 10
          done

      - name: Install Okta AD Agent via SSM
        id: install-agent
        run: |
          # Create PowerShell script for agent installation
          INSTALL_SCRIPT=$(cat <<'PWSH'
          $ErrorActionPreference = "Stop"

          # Okta org URL and token from environment
          $OktaOrgUrl = $env:OKTA_ORG_URL
          $AgentToken = $env:OKTA_AGENT_TOKEN

          if (-not $OktaOrgUrl -or -not $AgentToken) {
              Write-Output "ERROR: OKTA_ORG_URL and OKTA_AGENT_TOKEN must be set"
              exit 1
          }

          Write-Output "Installing Okta AD Agent..."
          Write-Output "Okta Org: $OktaOrgUrl"

          # Download installer
          $InstallerUrl = "https://op1static.oktacdn.com/fs/agents/OktaADAgentSetup.exe"
          $InstallerPath = "C:\OktaADAgentSetup.exe"

          Write-Output "Downloading Okta AD Agent installer..."
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $InstallerUrl -OutFile $InstallerPath

          # Check if agent is already installed
          $ExistingService = Get-Service -Name "OktaAgentSvc" -ErrorAction SilentlyContinue
          if ($ExistingService) {
              Write-Output "Okta AD Agent is already installed. Stopping service for update..."
              Stop-Service -Name "OktaAgentSvc" -Force
              Start-Sleep -Seconds 5
          }

          # Run installer silently
          Write-Output "Running Okta AD Agent installer..."
          $InstallArgs = "/q /S ORG_URL=$OktaOrgUrl AGENT_REGISTRATION_TOKEN=$AgentToken"
          $Process = Start-Process -FilePath $InstallerPath -ArgumentList $InstallArgs -Wait -PassThru

          if ($Process.ExitCode -ne 0) {
              Write-Output "ERROR: Installation failed with exit code $($Process.ExitCode)"
              exit 1
          }

          # Wait for service to start
          Start-Sleep -Seconds 10

          # Verify installation
          $Service = Get-Service -Name "OktaAgentSvc" -ErrorAction SilentlyContinue
          if ($Service -and $Service.Status -eq "Running") {
              Write-Output "SUCCESS: Okta AD Agent installed and running"
          } else {
              Write-Output "WARNING: Agent installed but service may not be running"
              Get-Service -Name "Okta*" | Format-Table Name, Status
          }

          # Cleanup
          Remove-Item -Path $InstallerPath -Force -ErrorAction SilentlyContinue

          Write-Output "Installation complete"
          PWSH
          )

          # Send command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.get-instance.outputs.instance_id }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters "commands=[\"$INSTALL_SCRIPT\"]" \
            --timeout-seconds 600 \
            --region ${{ inputs.region }} \
            --query "Command.CommandId" \
            --output text \
            --environment "OKTA_ORG_URL=${{ secrets.OKTA_ORG_URL }},OKTA_AGENT_TOKEN=${{ secrets.OKTA_AD_AGENT_TOKEN }}")

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Command ID: $COMMAND_ID"

      - name: Wait for Installation to Complete
        run: |
          echo "Waiting for installation to complete..."

          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${{ steps.install-agent.outputs.command_id }}" \
              --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
              --query "Status" \
              --output text \
              --region ${{ inputs.region }} 2>/dev/null || echo "Pending")

            if [ "$STATUS" = "Success" ]; then
              echo "Installation completed successfully!"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "Installation failed with status: $STATUS"

              # Get error output
              aws ssm get-command-invocation \
                --command-id "${{ steps.install-agent.outputs.command_id }}" \
                --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
                --region ${{ inputs.region }}

              exit 1
            fi

            echo "Status: $STATUS - waiting... ($i/60)"
            sleep 10
          done

      - name: Get Installation Output
        run: |
          echo "## Okta AD Agent Installation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "${{ steps.install-agent.outputs.command_id }}" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --query "StandardOutputContent" \
            --output text \
            --region ${{ inputs.region }})

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
